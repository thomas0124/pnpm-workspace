name: Deploy to Production Environment

on:
  push:
    branches:
      - main

env:
  PNPM_VERSION: "9.15.5"
  NODE_VERSION: "20"
  CLOUDFLARE_WORKERS_SUBDOMAIN: "sekibun3109"

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production (Cloudflare)
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run checks
        run: pnpm run check

      - name: Build packages
        run: pnpm run build

      - name: Setup Cloudflare Wrangler
        run: pnpm add -g wrangler@3

      - name: Generate database migrations
        working-directory: packages/backend
        run: |
          echo "ðŸ“ Checking for schema changes and generating migrations..."
          pnpm run db:generate
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ -d "drizzle/migrations" ] && [ "$(ls -A drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "âœ… Migrations generated/updated"
            ls -la drizzle/migrations/
          else
            echo "âš ï¸ No migrations generated (schema may be unchanged)"
          fi

      - name: Create or get D1 database for Production
        id: d1-setup
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DB_NAME="ar-pamph-db-production"
          echo "DB_NAME=$DB_NAME" >> $GITHUB_OUTPUT
          
          # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          DB_LIST=$(wrangler d1 list --json || echo "[]")
          DB_ID=$(echo "$DB_LIST" | jq -r ".[] | select(.name==\"$DB_NAME\") | .uuid" || echo "")
          
          if [ -z "$DB_ID" ]; then
            echo "Creating new D1 database: $DB_NAME"
            DB_CREATE=$(wrangler d1 create "$DB_NAME" --json)
            DB_ID=$(echo "$DB_CREATE" | jq -r '.uuid')
            echo "âœ… Created database with ID: $DB_ID"
          else
            echo "âœ… Using existing D1 database: $DB_NAME (ID: $DB_ID)"
          fi
          
          echo "DB_ID=$DB_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml with D1 database ID
        working-directory: packages/backend
        run: |
          # Productionç’°å¢ƒã®database_idã‚’å‹•çš„ã«è¨­å®š
          sed -i '/\[env\.production\.d1_databases\]/,/database_id = ""/ s/database_id = ""/database_id = "${{ steps.d1-setup.outputs.DB_ID }}"/' wrangler.toml
          echo "Updated wrangler.toml:"
          cat wrangler.toml

      - name: Run D1 Database Migrations
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "drizzle/migrations" ] && [ "$(ls -A drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "ðŸ“¦ Applying database migrations..."
            wrangler d1 migrations apply ${{ steps.d1-setup.outputs.DB_NAME }} --remote --env production
            echo "âœ… Migrations applied successfully"
          else
            echo "âš ï¸ No migrations found, skipping..."
          fi

      - name: Deploy Backend to Cloudflare Workers (Production)
        id: deploy-backend
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
          DEPLOY_OUTPUT=$(wrangler deploy --env production)
          echo "$DEPLOY_OUTPUT"
          
          # ç’°å¢ƒå¤‰æ•°ã¨Workeråã‹ã‚‰æ˜Žç¤ºçš„ã«URLã‚’ç”Ÿæˆ
          WORKER_NAME="ar-pamph"
          WORKER_URL="https://${WORKER_NAME}.${CLOUDFLARE_WORKERS_SUBDOMAIN}.workers.dev"
          
          echo "WORKER_URL=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: $WORKER_URL"

      - name: Build Frontend with Production API URL
        working-directory: packages/frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-backend.outputs.WORKER_URL }}
          NODE_ENV: production
        run: |
          echo "Building frontend with API URL: $NEXT_PUBLIC_API_URL"
          pnpm run build

      - name: Deploy Frontend to Cloudflare Pages (Production)
        id: deploy-frontend
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆproductionç’°å¢ƒï¼‰
          npx wrangler pages deploy .next --project-name=ar-pamph --branch=main
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã‚’ç”Ÿæˆ
          PAGES_URL="https://ar-pamph.pages.dev"
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed to: $PAGES_URL"

      - name: Create deployment summary
        run: |
          echo "## ðŸŽ‰ Production Environment Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Frontend (Live)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— ${{ steps.deploy-frontend.outputs.PAGES_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Backend API (Live)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— ${{ steps.deploy-backend.outputs.WORKER_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—„ï¸ Database" >> $GITHUB_STEP_SUMMARY
          echo "D1 Database: \`${{ steps.d1-setup.outputs.DB_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Author: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment success
        if: success()
        run: |
          echo "::notice title=Production Deployment::Successfully deployed to production! ðŸš€"
          echo "Frontend: ${{ steps.deploy-frontend.outputs.PAGES_URL }}"
          echo "Backend: ${{ steps.deploy-backend.outputs.WORKER_URL }}"

