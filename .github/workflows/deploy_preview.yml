name: Deploy Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PNPM_VERSION: "9.15.5"
  NODE_VERSION: "20"
  CLOUDFLARE_WORKERS_SUBDOMAIN: "sekibun3109"

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    name: Deploy Preview to Cloudflare
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Setup Cloudflare Wrangler
        run: pnpm add -g wrangler@3

      - name: Generate database migrations
        working-directory: packages/backend
        run: |
          echo "ğŸ“ Checking for schema changes and generating migrations..."
          pnpm run db:generate
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ -d "drizzle/migrations" ] && [ "$(ls -A drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "âœ… Migrations generated/updated"
            ls -la drizzle/migrations/
          else
            echo "âš ï¸ No migrations generated (schema may be unchanged)"
          fi

      - name: Create or get D1 database
        id: d1-setup
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # PRç•ªå·ã‚’ä½¿ã£ãŸä¸€æ„ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
          DB_NAME="ar-pamph-db-pr-${{ github.event.pull_request.number }}"
          echo "DB_NAME=$DB_NAME" >> $GITHUB_OUTPUT

          # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          DB_LIST=$(wrangler d1 list --json || echo "[]")
          DB_ID=$(echo "$DB_LIST" | jq -r ".[] | select(.name==\"$DB_NAME\") | .uuid" || echo "")

          if [ -z "$DB_ID" ]; then
            echo "Creating new D1 database: $DB_NAME"
            wrangler d1 create "$DB_NAME"
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆã®åæ˜ ã‚’å¾…ã¤ï¼ˆãƒªãƒˆãƒ©ã‚¤ï¼‹æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
            for i in {1..5}; do
              DB_ID=$(wrangler d1 list --json | jq -r ".[] | select(.name==\"$DB_NAME\") | .uuid")
              if [ -n "$DB_ID" ]; then
                echo "Created database with ID: $DB_ID"
                break
              fi
              echo "Waiting for database to be available (attempt $i/5)..."
              sleep $((2 ** i))
            done
            if [ -z "$DB_ID" ]; then
              echo "Error: Failed to retrieve database ID after creation"
              exit 1
            fi
          else
            echo "Using existing D1 database: $DB_NAME (ID: $DB_ID)"
          fi

          echo "DB_ID=$DB_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml with D1 database ID
        working-directory: packages/backend
        run: |
          # Previewç’°å¢ƒã®database_nameã¨database_idã‚’å‹•çš„ã«è¨­å®š
          DB_NAME="${{ steps.d1-setup.outputs.DB_NAME }}"
          DB_ID="${{ steps.d1-setup.outputs.DB_ID }}"
          
          # env.preview.d1_databasesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®database_nameã‚’æ›´æ–°
          sed -i "s|database_name = \"ar-pamph-db-preview\"|database_name = \"$DB_NAME\"|" wrangler.toml
          
          # env.preview.d1_databasesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®database_idã‚’æ›´æ–°
          # [[env.preview.d1_databases]]ã‹ã‚‰æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã®ç¯„å›²ã§database_idã‚’ç½®æ›
          sed -i "/\[\[env.preview.d1_databases\]\]/,/^\[\[/ s|database_id = \"\"|database_id = \"$DB_ID\"|" wrangler.toml
          
          cat wrangler.toml

      - name: Run D1 Database Migrations
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "drizzle/migrations" ] && [ "$(ls -A drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "ğŸ“¦ Applying database migrations..."
            wrangler d1 migrations apply ${{ steps.d1-setup.outputs.DB_NAME }} --remote --env preview
            echo "âœ… Migrations applied successfully"
          else
            echo "âš ï¸ No migrations found, skipping..."
          fi

      - name: Deploy Backend to Cloudflare Workers
        id: deploy-backend
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Previewç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
          DEPLOY_OUTPUT=$(wrangler deploy --env preview)
          echo "$DEPLOY_OUTPUT"

          # ç’°å¢ƒå¤‰æ•°ã¨Workeråã‹ã‚‰æ˜ç¤ºçš„ã«URLã‚’ç”Ÿæˆ
          WORKER_NAME="ar-pamph-preview"
          WORKER_URL="https://${WORKER_NAME}.${CLOUDFLARE_WORKERS_SUBDOMAIN}.workers.dev"
          
          echo "WORKER_URL=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: $WORKER_URL"

      - name: Build Frontend
        working-directory: packages/frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-backend.outputs.WORKER_URL }}
        run: |
          echo "Building frontend with API URL: $NEXT_PUBLIC_API_URL"
          pnpm run build

      - name: Create Cloudflare Pages project if not exists
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
          PROJECTS=$(wrangler pages project list 2>/dev/null || echo "")
          PROJECT_EXISTS=$(echo "$PROJECTS" | grep -q "ar-pamph" && echo "exists" || echo "")
          
          if [ -z "$PROJECT_EXISTS" ]; then
            echo "Creating Cloudflare Pages project: ar-pamph"
            wrangler pages project create ar-pamph --production-branch=main
          else
            echo "Project ar-pamph already exists"
          fi

      - name: Deploy Frontend to Cloudflare Pages
        id: deploy-frontend
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆé™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸoutãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
          wrangler pages deploy out --project-name=ar-pamph --branch=preview-pr-${{ github.event.pull_request.number }}

          # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã‚’ç”Ÿæˆ
          PAGES_URL="https://preview-pr-${{ github.event.pull_request.number }}.ar-pamph.pages.dev"
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed to: $PAGES_URL"

      - name: Comment PR with deployment URLs
        uses: actions/github-script@v7
        env:
          FRONTEND_URL: ${{ steps.deploy-frontend.outputs.PAGES_URL }}
          BACKEND_URL: ${{ steps.deploy-backend.outputs.WORKER_URL }}
          DB_NAME: ${{ steps.d1-setup.outputs.DB_NAME }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const frontendUrl = process.env.FRONTEND_URL;
            const backendUrl = process.env.BACKEND_URL;
            const dbName = process.env.DB_NAME;

            const comment = `## ğŸš€ Preview Environment Deployed!

            ### ğŸ“± Frontend
            ${frontendUrl}

            ### âš™ï¸ Backend API
            ${backendUrl}

            ### ğŸ—„ï¸ Database
            D1 Database: \`${dbName}\`

            ---

            Previewç’°å¢ƒãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼
            å„URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            *ã“ã®Previewç’°å¢ƒã¯PRãŒãƒãƒ¼ã‚¸ã¾ãŸã¯ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã¾ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

