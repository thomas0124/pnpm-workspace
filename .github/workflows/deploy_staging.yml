name: Deploy to Staging Environment

on:
  push:
    branches:
      - develop

env:
  PNPM_VERSION: "9.15.5"
  NODE_VERSION: "20"
  CLOUDFLARE_WORKERS_SUBDOMAIN: "sekibun3109"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging (Cloudflare)
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Setup Cloudflare Wrangler
        run: pnpm add -g wrangler@3

      - name: Generate database migrations
        working-directory: packages/backend
        run: |
          echo "ðŸ“ Checking for schema changes and generating migrations..."
          
          # æ—¢å­˜ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆæ—¢å­˜DBã‚’å†åˆ©ç”¨ã™ã‚‹ãŸã‚ã€æ¯Žå›žæ–°è¦ç”Ÿæˆï¼‰
          if [ -d "infrastructure/persistence/drizzle/migrations" ]; then
            echo "ðŸ—‘ï¸ Cleaning up existing migration files..."
            rm -f infrastructure/persistence/drizzle/migrations/*.sql
            rm -f infrastructure/persistence/drizzle/migrations/meta/*.json
            echo "âœ… Existing migration files removed"
          fi
          
          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°è¦ç”Ÿæˆ
          pnpm run db:generate
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ -d "infrastructure/persistence/drizzle/migrations" ] && [ "$(ls -A infrastructure/persistence/drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "âœ… Migrations generated/updated"
            ls -la infrastructure/persistence/drizzle/migrations/
          else
            echo "âš ï¸ No migrations generated (schema may be unchanged)"
          fi

      - name: Create or get D1 database for Staging
        id: d1-setup
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DB_NAME="ar-pamph-db-staging"
          echo "DB_NAME=$DB_NAME" >> $GITHUB_OUTPUT
          
          # æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          DB_LIST=$(wrangler d1 list --json || echo "[]")
          DB_ID=$(echo "$DB_LIST" | jq -r ".[] | select(.name==\"$DB_NAME\") | .uuid" || echo "")
          
          if [ -z "$DB_ID" ]; then
            echo "Creating new D1 database: $DB_NAME"
            wrangler d1 create "$DB_NAME"
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆã®åæ˜ ã‚’å¾…ã¤ (exponential backoff)
            for i in {1..5}; do
              DB_ID=$(wrangler d1 list --json | jq -r ".[] | select(.name==\"$DB_NAME\") | .uuid")
              if [ -n "$DB_ID" ]; then
                break
              fi
              echo "Waiting for database to be available (attempt $i/5)..."
              sleep $((2 ** i))
            done
            if [ -z "$DB_ID" ]; then
              echo "Error: Failed to retrieve database ID after creation"
              exit 1
            fi
            echo "âœ… Created database with ID: $DB_ID"
          else
            echo "Using existing D1 database: $DB_NAME (ID: $DB_ID)"
          fi
          
          echo "DB_ID=$DB_ID" >> $GITHUB_OUTPUT

      - name: Update wrangler.toml with D1 database ID
        working-directory: packages/backend
        run: |
          # Stagingç’°å¢ƒã®database_idã‚’å‹•çš„ã«è¨­å®š
          sed -i '/\[env\.staging\.d1_databases\]/,/database_id = ""/ s/database_id = ""/database_id = "${{ steps.d1-setup.outputs.DB_ID }}"/' wrangler.toml
          echo "Updated wrangler.toml:"
          cat wrangler.toml

      - name: Run D1 Database Migrations
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "infrastructure/persistence/drizzle/migrations" ] && [ "$(ls -A infrastructure/persistence/drizzle/migrations/*.sql 2>/dev/null)" ]; then
            echo "ðŸ“¦ Applying database migrations..."
            
            # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            if wrangler d1 migrations apply ${{ steps.d1-setup.outputs.DB_NAME }} --remote --env staging 2>&1 | tee /tmp/migration_output.log; then
              echo "âœ… Migrations applied successfully"
            else
              MIGRATION_ERROR=$(cat /tmp/migration_output.log)
              # table already exists ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šã‚’å‡ºã—ã¦ç¶šè¡Œ
              if echo "$MIGRATION_ERROR" | grep -q "already exists"; then
                echo "âš ï¸ Warning: Some tables already exist. This is expected when reusing an existing database."
                echo "âš ï¸ The migration may have been partially applied. Continuing deployment..."
              else
                echo "âŒ Migration failed with error:"
                echo "$MIGRATION_ERROR"
                exit 1
              fi
            fi
          else
            echo "âš ï¸ No migrations found, skipping..."
          fi

      - name: Deploy Backend to Cloudflare Workers (Staging)
        id: deploy-backend
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Stagingç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
          DEPLOY_OUTPUT=$(wrangler deploy --env staging)
          echo "$DEPLOY_OUTPUT"
          
          # ç’°å¢ƒå¤‰æ•°ã¨Workeråã‹ã‚‰æ˜Žç¤ºçš„ã«URLã‚’ç”Ÿæˆ
          WORKER_NAME="ar-pamph-staging"
          WORKER_URL="https://${WORKER_NAME}.${CLOUDFLARE_WORKERS_SUBDOMAIN}.workers.dev"
          
          echo "WORKER_URL=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: $WORKER_URL"

      - name: Build Frontend with Staging API URL
        working-directory: packages/frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.deploy-backend.outputs.WORKER_URL }}
        run: |
          echo "Building frontend with API URL: $NEXT_PUBLIC_API_URL"
          pnpm run build

      - name: Create Cloudflare Pages project if not exists
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
          PROJECTS=$(wrangler pages project list 2>/dev/null || echo "")
          PROJECT_EXISTS=$(echo "$PROJECTS" | grep -q "ar-pamph-staging" && echo "exists" || echo "")
          
          if [ -z "$PROJECT_EXISTS" ]; then
            echo "Creating Cloudflare Pages project: ar-pamph-staging"
            wrangler pages project create ar-pamph-staging --production-branch=main
          else
            echo "Project ar-pamph-staging already exists"
          fi

      - name: Deploy Frontend to Cloudflare Pages (Staging)
        id: deploy-frontend
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆé™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸoutãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
          wrangler pages deploy out --project-name=ar-pamph-staging --branch=main
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã‚’ç”Ÿæˆ
          PAGES_URL="https://ar-pamph-staging.pages.dev"
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed to: $PAGES_URL"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Staging Environment Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Frontend" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deploy-frontend.outputs.PAGES_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Backend API" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deploy-backend.outputs.WORKER_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—„ï¸ Database" >> $GITHUB_STEP_SUMMARY
          echo "D1 Database: \`${{ steps.d1-setup.outputs.DB_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Deployed from: \`${{ github.ref }}\` @ \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

